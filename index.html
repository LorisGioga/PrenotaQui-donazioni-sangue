<!-- ================================================================================= -->
<!-- PrenotaQui 2.0  01 - 31 - 2026  -->
<!-- ================================================================================= -->
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gruppo FIDAS adsp - Prenotazioni</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    
    <header class="global-header">
        <div class="header-content">
            <img src="logofidas.png" alt="Logo FIDAS" class="header-logo">
            <span class="header-text">Gruppo FIDAS adsp di San Giusto Canavese</span>
        </div>
    </header>

    <div id="app" class="container" :class="view" v-cloak> 
     
        <!-- PRIMA PAGINA:  Titolo e informativa PRIVACY -->
        <div v-if="view==='landing'">
            <h1 class="main-title">PrenotaQui 2</h1>
            <h2>Benvenuto nella nostra Applicazione per le prenotazioni</h2>
            <p>&nbsp;&nbsp;&nbsp;</p>
            <hr>
            <h3>INFORMATIVA SULLA GESTIONE DEI DATI PERSONALI DEI DONATORI:</h3>
            
            <p class="privacy-text">Ai sensi del Regolamento (UE) 2016/679 (GDPR), informiamo che i dati personali inseriti nel presente modulo di prenotazione sono trattati esclusivamente per finalit√† organizzative legate alla donazione di sangue. Il trattamento √® svolto da persone autorizzate dal Presidente del Gruppo FIDAS San Giusto, Titolare del trattamento, nell'ambito delle attivit√† associative e in conformit√† all'informativa sottoscritta dal donatore al momento dell'iscrizione alla FIDAS. I dati raccolti non saranno utilizzati per altri scopi e non saranno comunicati a soggetti terzi, salvo obblighi di legge. Il trattamento avviene nel rispetto delle misure di sicurezza previste dalla normativa vigente. Per ulteriori informazioni sul trattamento dei dati, √® possibile consultare l'Informativa Privacy FIDAS disponibile presso la sede o richiederne copia al momento della donazione.</p>
            
            <h4>Prenotandoti, DICHIARI di aver preso visione di questa formativa.</h4>
            <hr> 
            
            <!-- PRIMA PAGINA:  LOGIN -->
            <div class="login-box">
                <h4 style="text-align: center; margin-bottom: 20px;">Login</h4>
                <h3 style="text-align: center; margin-bottom: 20px;">Accedi con le tue credenziali</h3>
                <input type="email" v-model="user.email" placeholder="E-mail" 
                       @keyup.enter="login()"
                       class="landing-input">
                <input type="password" v-model="user.password" placeholder="Password" 
                       @keyup.enter="login()"
                       class="landing-input">
                <button @click="login()" class="landing-login-btn">Accedi</button>
                
                <div class="register-prompt">
                    <p class="register-text">Non hai ancora le credenziali di accesso?<br>Registrati con il tasto "Nuovo utente"</p>
                    <button @click="view='register'" class="register-btn">Nuovo Utente</button>
                </div>
            </div>
        </div>

        <!-- PAGINA REGISTRAZIONE (tutti i campi) -->
        <div v-else-if="view==='register'">
            <h1 class="main-title">Registrazione Nuovo Utente</h1>
            <h2>Compila tutti i campi richiesti</h2>
            <p>&nbsp;&nbsp;&nbsp;</p>
            
            <p style="margin-top:20px; font-size:1.1em; color:#2e2d2d; text-align:left;">
             I tuoi dati verranno salvati. Clicca su "Pagina successiva" per proseguire con la prenotazione.
            </p>  
             <p style="margin-bottom:20px; font-size:1.1em; color:#2e2d2d; text-align:left;">
                Per i futuri accessi, potrai utilizzare direttamente l'area Login.
            </p>  
            
            <div class="form-container">
                <input type="text" v-model="user.lastName" placeholder="Cognome" required
                  @keydown.tab.prevent="focusNext($event)"
                  @keydown.arrow-down.prevent="focusNext($event)">
                <input type="text" v-model="user.firstName" placeholder="Nome" required
                  @keydown.tab.prevent="focusNext($event)"
                  @keydown.arrow-down.prevent="focusNext($event)">
                <input type="text" v-model="user.matricola" placeholder="Matricola (dal tesserino)" required
                  @keydown.tab.prevent="focusNext($event)"
                  @keydown.arrow-down.prevent="focusNext($event)">
                <input type="email" v-model="user.email" placeholder="E-mail" required
                  @keydown.tab.prevent="focusNext($event)"
                  @keydown.arrow-down.prevent="focusNext($event)">
                <input type="password" v-model="user.password" placeholder="Password" required
                  @keydown.tab.prevent="focusNext($event)"
                  @keydown.arrow-down.prevent="focusNext($event)"
                  @keyup.enter="register()">
            </div>
              
            <p>&nbsp;&nbsp;&nbsp;</p>
            <button @click="view='landing'" class="btn-back">Indietro</button>
            <button @click="register()" class="btn-forward">Pagina Successiva</button>
             <p style="margin-top:20px; font-size:1em; color:#2e2d2d; text-align:left;">
             ‚ÑπÔ∏è Dopo la registrazione il caricamento dei dati richieder√† circa 5-6 secondi. 
             Ti preghiamo di attendere.
            </p>  
        </div>

        <!-- SECONDA PAGINA: Lista persone IDONEE (dopo login) -->
        <div v-else-if="view==='idoneiPage'" :key="'idonei-' + idoneiList.length">
            <h1 class="main-title">{{ idoneiTitle }}</h1>
                           
            <!-- Nav principale per navigazione -->
            <nav class="top-nav">
                <div></div>
                <div>
                    
                    <button @click="logout()" class="btn-back">Indietro</button>
                    <button @click="view='pageSelect'" class="btn-forward">Avanti</button>
                    <button v-if="!isAdmin" @click="adminLogin()" class="btn-admin">Area Riservata</button>
                    <button class="exit" @click="logout()">Esci</button>
                </div>
            </nav>

            <!-- separata per il pulsante Aggiorna -->
            <h2 style="margin-top:10px; text-align:center;">Elenco delle persone idonee alla donazione</h2>
            <p>&nbsp;&nbsp;&nbsp;</p>
            <button @click="forceReloadIdonei()" class="btn-refresh">üîÑ Aggiorna Lista</button>

             <p style="margin-top:20px; font-size:1em; color:#2e2d2d; text-align:left;">
                ‚ÑπÔ∏è La lista delle persone idonee viene caricata automaticamente.
                Se non la visualizzi subito, clicca su "üîÑ Aggiorna lista" per ricaricarla.
            </p>     
             <p style="margin-top:20px; font-size:0.9em; color:#666464; text-align:left;">
                ‚ÑπÔ∏è I nomi completi sono visibili solo alle persone con la propria matricola.
            </p>   
            <p v-if="idoneiList.length === 0" style="color:#999; font-style:italic; text-align:center; margin:30px 0;">
                Nessuna lista disponibile al momento.
            </p>

            <table v-else class="bookings-table">
                <thead>
                    <tr><th>Matricola</th><th>Nome Cognome</th></tr>
                </thead>
                <tbody>
                    <tr v-for="(persona, idx) in idoneiList" :key="idx" 
                        :class="{ 'highlight-user': user.matricola && String(persona.matricola) === String(user.matricola) }">
                        <td>{{ persona.matricola }}</td>
                        <td>{{ mask(persona.cognome + ' ' + persona.nome, persona.matricola) }}</td>
                    </tr>
                </tbody>
            </table>

            <!-- TERZA PAGINA:  Seleziona una pagina -->
        </div>

        <div v-else-if="view==='pageSelect'">
            <h1 class="main-title">Seleziona una pagina</h1>
            <nav class="top-nav">
                <div></div>
                <div>
                    <button @click="adminLogin()" class="btn-admin">Area Riservata</button>
                    <button class="exit" @click="logout()">Esci</button>
                </div>
            </nav>
            <label class="page-select-label">Scegli quando Donare e verifica la disponibilit√†:
                <select v-model="user.pageChoice">
                    <option v-for="(name, key) in pageNames" :key="key" :value="key">
                        {{ name }}
                    </option>
                </select>
            </label>
            
            <p style="margin-top:20px; font-size:1em; color:#2e2d2d; text-align:left;">
                ‚ÑπÔ∏è Anche se sono presenti pi√π pagine, puoi effettuare una sola prenotazione complessiva.
            </p>  
            <p>&nbsp;&nbsp;&nbsp;</p>   
            <button @click="view='idoneiPage'" class="btn-back">Indietro</button>
            <button @click="enterPage()" class="btn-forward">Avanti</button>
            <h3></h3>
            <p></p>

            <!-- TERZA PAGINA:  Area Riservata per Modificare  -->
            <div v-if="isAdmin" class="admin-settings">
                
                <div class="admin-section-header">
                    <h3>Gestione Pagine</h3>
                    <button class="admin-exit" @click="exitAdmin()">Esci Area Riservata</button>
                </div>
                
                <label>Aggiungi Nuova Pagina:</label>
                <input type="text" v-model="newPageName" placeholder="Nome nuova pagina (es. Gennaio)">
                <button @click="addPage()">Aggiungi Pagina</button>
                <p>&nbsp;&nbsp;&nbsp;</p>
                <hr>
                
                <h3>Rinomina Pagine</h3>
                <div v-for="(name, key, index) in pageNames" :key="key" class="page-management-row">
                    <label>Pagina {{ index + 1 }}:</label>
                    <input class="page-name-input" :value="name" @change="e => updatePageName(key, e.target.value)">
                    <button v-if="Object.keys(pageNames).length > 1" @click="removePage(key)" class="reset">Rimuovi</button>
                </div>               
                <p>&nbsp;&nbsp;&nbsp;</p>
                <hr>
                <hr>

                <h3>Blocca Prenotazioni</h3>
                <p style="font-size:0.9em; color:#ff6600; margin-bottom:10px; font-weight: bold;">
                    ‚ö†Ô∏è Il blocco vale solo per gli utenti normali. L'admin pu√≤ sempre operare.
                </p>
                <div v-for="(name, key) in pageNames" :key="key">
                    <label><input type="checkbox" v-model="blocks[key]" @change="updateBlock(key)"> Blocca: {{ name }}</label>
                </div>
                <p>&nbsp;&nbsp;&nbsp;</p>
                <hr>
                <hr>

                <h3>Modifica Testi</h3>
                <label>I Pagina:</label>
                <input class="text-input" v-model="texts.landing" @change="updateText('landing')">
                <label>Pagina della selezione pagine:</label>
                <input class="text-input" v-model="texts.pageSelect" @change="updateText('pageSelect')">
                <p>&nbsp;&nbsp;&nbsp;</p>
                <hr>
                <hr>
                
                <h3>Numero Posti per Fascia Oraria</h3>
                <label>Posti disponibili per ogni fascia (escluse Riserve):</label>
                <input type="number" v-model.number="seatsPerSlot" @change="updateSeatsPerSlot()" 
                       min="1" max="20" placeholder="Numero posti (es. 6)">
                <small style="display:block; margin-top:5px; color:#666;">Valore attuale: {{ seatsPerSlot }} posti per fascia</small>
                <p>&nbsp;&nbsp;&nbsp;</p>
                <hr>
                <hr>

                <h3>Modifica password admin</h3>
                <input type="password" v-model="adminPass" @change="updateAdminPass()" placeholder="Nuova password admin">
                
                <p>&nbsp;&nbsp;&nbsp;</p>
                <hr>
                <hr>

                <h3>Gestione Lista Persone Idonee</h3>
                <label>Titolo Pagina Idonei:</label>
                <input class="text-input" v-model="idoneiTitle" @blur="updateIdoneiTitle()">
                
                <div style="margin-top:15px;">
                    <button @click="importExcelIdonei()">Carica Lista Excel</button>
                    <button class="reset" @click="resetIdoneiList()">Cancella Lista</button>
                    <input ref="fileInputIdonei" type="file" accept=".xlsx" @change="handleFileUploadIdonei" style="display:none">
                </div>

                <p style="margin-top:10px; font-size:0.9em; color:#676565;">
                    Il file Excel deve contenere le colonne: <strong>Matricola</strong> e <strong>Nome</strong> (formato: "COGNOME NOME")
                </p>

                <div v-if="idoneiList.length > 0" style="background:#f0f0f0; padding:15px; border-radius:8px; margin-top:15px;">
                    <h4>Lista Caricata ({{ idoneiList.length }} persone)</h4>
                    <div v-for="(persona, idx) in idoneiList.slice(0, 5)" :key="idx" style="padding:8px 0; border-bottom:1px solid #ddd;">
                        <strong>{{ persona.matricola }}</strong> - {{ persona.cognome }} {{ persona.nome }}
                    </div>
                    <p v-if="idoneiList.length > 5" style="color:#666; font-style:italic; margin-top:10px;">
                        ... e altre {{ idoneiList.length - 5 }} persone
                    </p>
                </div>
            </div>
        </div>

        <!-- QUARTA PAGINA:  Prenotazione -->
        <div v-else-if="Object.keys(pageNames).includes(view)"> 
            <h1 class="main-title">Pagina prenotazione</h1>
            <nav class="top-nav">
                <div></div>
                <div>
                    <button @click="view='pageSelect'" class="btn-back">Indietro</button> 
                    <button v-if="!isAdmin" @click="adminLogin()" class="btn-admin">Area Riservata</button>
                    <button class="exit" @click="logout()">Esci</button>
                </div>
            </nav>
            <h2 contenteditable="true" @blur="updatePageName(view, $event.target.innerText)" class="session-title">{{ pageNames[view] }}</h2>
            
            <div class="booking-section">
                <button v-if="isAdmin" class="admin-exit" @click="exitAdmin()">Esci Area Riservata</button>
                
                <div v-if="!isAdmin" class="user-booking-info">
                    <input type="text" :value="user.matricola + ' ' + user.lastName + ' ' + user.firstName" disabled>
                </div>
                <div v-else class="admin-booking-fields">
                    <input type="text" v-model="booking.matricola" placeholder="Matricola">
                    <input type="text" v-model="booking.name" placeholder="Cognome Nome">
                </div>
          
                <p style="margin-top:20px; font-size:1em; color:#2e2d2d; text-align:left;">
                ‚ÑπÔ∏è Seleziona una fascia oraria disponibile e clicca su Prenota per confermare.
                </p>  
                <select v-model.number="booking.slot" class="slot-select">
                    <option :value="null">Seleziona fascia</option>
                    <option v-for="slot in slots" :key="slot.id" :value="slot.id" :disabled="slot.id!==8 && remaining(slot)<=0">
                        {{ slot.id===8 ? 'Riserve' : slot.label }} ‚Äì {{ remaining(slot) }} {{ remaining(slot)===1 ? 'posto' : 'posti' }}
                    </option>
                </select>
                
                
                <p>&nbsp;&nbsp;</p>
                <button @click="confirmBook()">Prenota</button>
            </div>
            <p>&nbsp;&nbsp;&nbsp;</p>
             
            <div v-if="isAdmin" class="admin-actions">
                <button class="reset" @click="resetAll()">Resetta Tutto</button>
                <button @click="exportExcel()">Scarica Excel</button>
                <button @click="importExcel()">Carica Excel</button>
                <input type="file" ref="fileInput" @change="handleFileUpload" style="display:none" />
            </div>

            <table class="bookings-table">
                <thead>
                    <tr><th>Ora</th><th>N.</th><th>Prenotazioni</th><th>Posti</th></tr>
                </thead>
                <tbody>
                    <tr v-for="slot in slots" :key="slot.id">
                        <td>{{ slot.id===8 ? 'Riserve' : slot.label }}</td>
                        <td><div v-for="j in seatsPerSlot" :key="j">{{ slot.id*seatsPerSlot + j }}</div></td>
                        <td>
                            <div v-for="b of bookingsBySlot[slot.id]" :key="b.key" class="prenotazione-nome"
                                 :class="{ 'user-booking': user.matricola && String(b.matricola) === String(user.matricola) }">
                                <span>{{ b.matricola }} {{ isAdmin ? b.name : mask(b.name, b.matricola) }}</span>
                                <button v-if="isAdmin" @click="removeBooking(b.key)">Cancella</button>
                            </div>
                        </td>
                        <td>
                            <span class="seats-badge" :class="{
                                'seats-many': remaining(slot) > 3,
                                'seats-few': remaining(slot) > 0 && remaining(slot) <= 3,
                                'seats-none': remaining(slot) === 0 && slot.id !== 8
                            }">
                                {{ remaining(slot) }} {{ remaining(slot)===1 ? 'posto' : 'posti' }}
                            </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- MODALE PERSONALIZZATO -->
        <div v-if="modal.show" class="modal-overlay" @click.self="modalCancel">
            <div class="modal-box">
                <h3 class="modal-title">{{ modal.title }}</h3>
                <p class="modal-message">{{ modal.message }}</p>
                <input v-if="modal.type === 'prompt'" v-model="modal.input" type="text" class="modal-input" @keyup.enter="modalConfirm" placeholder="Inserisci...">
                <div class="modal-buttons">
                    <button v-if="modal.type !== 'alert'" @click="modalCancel" class="modal-btn-cancel">Annulla</button>
                    <button @click="modalConfirm" class="modal-btn-ok">{{ modal.type === 'alert' ? 'OK' : 'Conferma' }}</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module" src="app.js"></script>
</body>
</html>